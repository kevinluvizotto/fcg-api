
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>FCG Admin - Painel</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            display: flex;
        }

        #sidebar {
            width: 250px;
            height: 100vh;
            background-color: #f8f9fa;
            padding: 1rem;
        }

        #content {
            flex-grow: 1;
            padding: 2rem;
        }

        .section {
            display: none;
        }

            .section.active {
                display: block;
            }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div id="sidebar">
        <h4>🔧 Admin Panel</h4>
        <hr>
        <button class="btn btn-outline-primary w-100 mb-2" onclick="showSection('games')">🎮 Gerenciar Jogos</button>
        <button class="btn btn-outline-primary w-100" onclick="showSection('users')">👥 Gerenciar Usuários</button>
        <hr>
        <button class="btn btn-secondary w-100" onclick="window.location.href='dashboard.html'">↩️ Voltar</button>
    </div>

    <!-- Conteúdo principal -->
    <div id="content">
        <!-- Seção de Jogos -->
        <div id="games" class="section active">
            <h3>🎮 Gerenciar Jogos</h3>
            <!-- Filtro -->
            <input type="text" class="form-control my-3" placeholder="Buscar jogo por título" id="search-game" onkeyup="filterGames()">

            <!-- Cadastro -->
            <form id="game-form" class="row g-2 mb-4">
                <div class="col-md-4">
                    <input type="text" class="form-control" id="title" placeholder="Título" required>
                </div>
                <div class="col-md-4">
                    <input type="text" class="form-control" id="description" placeholder="Descrição" required>
                </div>
                <div class="col-md-2">
                    <input type="number" step="0.01" class="form-control" id="price" placeholder="Preço" required>
                </div>
                <div class="col-md-2">
                    <button class="btn btn-success w-100" type="submit">Cadastrar</button>
                </div>
            </form>

            <div id="game-result" class="mb-3"></div>
            <div id="game-list"></div>
        </div>

        <!-- Seção de Usuários -->
        <div id="users" class="section">
            <h3>👥 Gerenciar Usuários</h3>
            <input type="text" class="form-control my-3" id="search-user" placeholder="Buscar por nome ou e-mail" onkeyup="filterUsers()">

            <form id="create-user-form" class="row g-2 mb-4">
                <div class="col-md-3"><input type="text" class="form-control" id="new-name" placeholder="Nome" required></div>
                <div class="col-md-3"><input type="email" class="form-control" id="new-email" placeholder="Email" required></div>
                <div class="col-md-3"><input type="password" class="form-control" id="new-password" placeholder="Senha" required></div>
                <div class="col-md-2">
                    <select class="form-select" id="new-role" required>
                        <option value="User">Usuário</option>
                        <option value="Admin">Admin</option>
                    </select>
                </div>
                <div class="col-md-1">
                    <button class="btn btn-success w-100" type="submit">Criar</button>
                </div>
            </form>

            <div id="user-list"></div>
        </div>
    </div>

    <script>
        const api = "";
        const token = localStorage.getItem("fcg_token");

        if (!token) {
            alert("Acesso negado. Faça login.");
            window.location.href = "login.html";
        }

        fetch(`${api}/me`, {
            headers: { "Authorization": `Bearer ${token}` }
        }).then(r => r.json()).then(data => {
            if (data.role !== "Admin") {
                alert("Apenas administradores podem acessar esta página.");
                window.location.href = "dashboard.html";
            }
        });

        function showSection(id) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        document.getElementById("game-form").addEventListener("submit", async (e) => {
            e.preventDefault();
            const body = {
                title: document.getElementById("title").value,
                description: document.getElementById("description").value,
                price: parseFloat(document.getElementById("price").value)
            };

            const res = await fetch(`${api}/games`, {
                method: "POST",
                headers: {
                    "Authorization": `Bearer ${token}`,
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(body)
            });

            const resultBox = document.getElementById("game-result");
            if (res.ok) {
                resultBox.innerHTML = `<div class="alert alert-success">✅ Jogo cadastrado!</div>`;
                document.getElementById("game-form").reset();
                loadGames();
            } else {
                const error = await res.text();
                resultBox.innerHTML = `<div class="alert alert-danger">❌ ${error}</div>`;
            }
        });

        async function loadGames() {
            const res = await fetch(`${api}/games`);
            const games = await res.json();
            window.allGames = games;
            renderGameList(games);
        }

        function renderGameList(games) {
            const html = games.map(g => `
                    <div class="border rounded p-3 mb-2">
                        <strong>${g.title}</strong><br>
                        ${g.description}<br>
                        💰 R$${g.price.toFixed(2)}<br>
                        <button class="btn btn-sm btn-outline-danger mt-2" onclick="deleteGame('${g.id}')">🗑️ Excluir</button>
                    </div>
                `).join("");
            document.getElementById("game-list").innerHTML = html;
        }

        function deleteGame(gameId) {
            if (!confirm("Tem certeza que deseja excluir este jogo?")) return;

            fetch(`${api}/games/${gameId}`, {
                method: "DELETE",
                headers: {
                    "Authorization": `Bearer ${token}`
                }
            })
                .then(async r => {
                    const msg = await r.text();
                    if (r.ok) {
                        alert("✅ " + msg);
                        loadGames();
                    } else {
                        alert("❌ " + msg);
                    }
                });
        }

        function filterGames() {
            const query = document.getElementById("search-game").value.toLowerCase();
            const filtered = window.allGames.filter(g => g.title.toLowerCase().includes(query));
            renderGameList(filtered);
        }

        async function loadUsers() {
            const res = await fetch(`${api}/users`, {
                headers: { "Authorization": `Bearer ${token}` }
            });
            const users = await res.json();
            window.allUsers = users;
            renderUserList(users);
        }

        function renderUserList(users) {
            const html = users.map(u => `
                    <div class="border rounded p-3 mb-2">
                        <strong>${u.name}</strong> (${u.email}) - <em>${u.role}</em><br>
                        <button class="btn btn-sm btn-outline-warning mt-2 me-2" onclick="editUser('${u.id}', '${u.name}', '${u.email}', '${u.role}')">✏️ Editar</button>
                        <button class="btn btn-sm btn-outline-danger mt-2" onclick="deleteUser('${u.id}')">🗑️ Excluir</button>
                    </div>
                `).join("");
            document.getElementById("user-list").innerHTML = html;
        }

        function deleteUser(userId) {
            if (!confirm("Tem certeza que deseja excluir este usuário?")) return;

            fetch(`${api}/users/${userId}`, {
                method: "DELETE",
                headers: {
                    "Authorization": `Bearer ${token}`
                }
            })
                .then(async r => {
                    const msg = await r.text();
                    if (r.ok) {
                        alert("✅ " + msg);
                        loadUsers();
                    } else {
                        alert("❌ " + msg);
                    }
                });
        }

        function filterUsers() {
            const query = document.getElementById("search-user").value.toLowerCase();
            const filtered = window.allUsers.filter(u =>
                u.name.toLowerCase().includes(query) || u.email.toLowerCase().includes(query)
            );
            renderUserList(filtered);
        }

        function editUser(id, name, email, role) {
            const newName = prompt("Novo nome:", name);
            const newEmail = prompt("Novo e-mail:", email);
            const newRole = prompt("Novo perfil (User/Admin):", role);

            if (newName && newEmail && newRole) {
                fetch(`${api}/users/${id}`, {
                    method: "PUT",
                    headers: {
                        "Authorization": `Bearer ${token}`,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({ name: newName, email: newEmail, role: newRole })
                })
                    .then(r => {
                        if (r.ok) {
                            alert("Usuário atualizado!");
                            loadUsers();
                        } else {
                            r.text().then(t => alert("Erro: " + t));
                        }
                    });
            }
        }

        document.getElementById("create-user-form").addEventListener("submit", async (e) => {
            e.preventDefault();

            const body = {
                name: document.getElementById("new-name").value,
                email: document.getElementById("new-email").value,
                passwordHash: document.getElementById("new-password").value,
                role: document.getElementById("new-role").value
            };

            const res = await fetch(`${api}/users`, {
                method: "POST",
                headers: {
                    "Authorization": `Bearer ${token}`,
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(body)
            });

            if (res.ok) {
                alert("Usuário criado!");
                e.target.reset();
                loadUsers();
            } else {
                const msg = await res.text();
                alert("Erro: " + msg);
            }
        });

        loadGames();
        loadUsers();
    </script>
</body>
</html>
